<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banco de Horas Evereste</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuração de Identidade Visual -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            navy: '#004080',
                            navyLight: '#00509d',
                            orange: '#FF7F00',
                            bg: '#F3F4F6',
                            surface: '#FFFFFF',
                            border: '#E5E7EB',
                            textMain: '#111827',
                            textSec: '#6B7280'
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    fontSize: {
                        'xs-mobile': '0.7rem', // Fonte menor para inputs mobile
                    }
                }
            }
        }
    </script>

    <!-- Fonte Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #F3F4F6; color: #111827; }
        
        /* Utilitários */
        .card {
            background-color: white; border: 1px solid #E5E7EB; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        
        /* Botões */
        .btn-primary {
            background-color: #004080; color: white; border-radius: 6px; font-weight: 500;
            padding: 12px; width: 100%; transition: background-color 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-secondary {
            background-color: #FF7F00; color: white; border-radius: 6px; font-weight: 500;
            padding: 12px; width: 100%; transition: background-color 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        /* Inputs */
        .input-field {
            background-color: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 6px;
            padding: 10px 12px; width: 100%; outline: none; transition: border-color 0.2s;
            font-size: 0.9rem; /* Levemente menor para caber */
        }
        .input-field:focus { border-color: #004080; background-color: white; }

        /* Estilo específico para input de hora manual */
        .input-time {
            text-align: center; font-family: monospace; font-weight: 700; letter-spacing: 1px; font-size: 1.1rem;
        }

        /* Navegação */
        .nav-container {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-top: 1px solid #E5E7EB; display: flex; justify-content: space-around;
            padding: 8px 0; z-index: 50; box-shadow: 0 -4px 15px rgba(0,0,0,0.03);
        }
        @media (min-width: 768px) {
            .nav-container {
                position: sticky; top: 80px; border: none; background: transparent;
                box-shadow: none; justify-content: flex-start; gap: 10px; padding: 0 0 20px 0;
            }
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9CA3AF; padding: 8px; border-radius: 8px; cursor: pointer; flex: 1;
            transition: all 0.2s; max-width: 100px;
        }
        @media (min-width: 768px) {
            .nav-btn {
                flex-direction: row; gap: 8px; background: white; border: 1px solid #E5E7EB;
                max-width: none; padding: 12px 24px; flex: 0 1 auto;
            }
        }

        .nav-btn.active { color: #004080; }
        .nav-btn.active i { transform: translateY(-2px); }
        @media (min-width: 768px) {
            .nav-btn.active {
                background-color: #004080; color: white; border-color: #004080;
                box-shadow: 0 4px 6px rgba(0,64,128,0.2);
            }
            .nav-btn.active i { color: #FF7F00; transform: none; }
        }

        .nav-icon { font-size: 1.2rem; margin-bottom: 4px; transition: transform 0.2s; }
        @media (min-width: 768px) { .nav-icon { margin-bottom: 0; font-size: 1rem; } }
        
        .nav-text { font-size: 0.7rem; font-weight: 500; }
        @media (min-width: 768px) { .nav-text { font-size: 0.9rem; } }

        /* Ajuste Main para Bottom Bar */
        main { padding-bottom: 80px; }
        @media (min-width: 768px) { main { padding-bottom: 20px; } }

        /* Timeline */
        .timeline-row { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #F3F4F6; }
        .timeline-row:last-child { border-bottom: none; }
        
        /* Overlays */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(4px);
            z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 110; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; border-left: 4px solid; padding: 16px; border-radius: 4px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px;
            animation: slideIn 0.3s ease-out; min-width: 300px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-brand-bg text-brand-textMain">

    <!-- Loading -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-brand-bg border-t-brand-navy rounded-full animate-spin mb-4"></div>
        <p class="text-brand-navy font-bold tracking-wider text-sm uppercase">Banco de Horas Evereste</p>
        <p class="text-xs text-gray-400 mt-2" id="loading-text">Conectando...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- TELA LOGIN -->
    <section id="login-screen" class="hidden fixed inset-0 bg-brand-bg z-50 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-lg shadow-lg border border-brand-border p-8">
            <div class="text-center mb-8">
                <i class="fa-solid fa-mountain-sun text-brand-orange text-5xl mb-4"></i>
                <h1 class="text-2xl font-bold text-brand-navy">Portal do Colaborador</h1>
                <p class="text-gray-500 text-sm mt-2">Instituto Evereste</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                    <input type="email" id="login-email" class="input-field" placeholder="seu.email@evereste.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Senha</label>
                    <input type="password" id="login-password" class="input-field" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn-primary py-3 shadow-md hover:shadow-lg">
                    Entrar no Sistema
                </button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-6">Acesso restrito a colaboradores autorizados.</p>
        </div>
    </section>

    <!-- HEADER (Fixo no Topo) -->
    <header class="bg-white border-b border-brand-border sticky top-0 z-40 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-brand-navy text-white w-9 h-9 rounded flex items-center justify-center">
                    <i class="fa-solid fa-mountain-sun text-brand-orange text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-brand-navy text-sm leading-tight">Banco de Horas</h1>
                    <p class="text-[10px] text-brand-orange font-bold uppercase tracking-wider">Evereste</p>
                </div>
            </div>

            <!-- Perfil & Logout -->
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Logado como</p>
                    <p id="header-user-name" class="text-sm font-bold text-brand-navy truncate max-w-[120px]">...</p>
                </div>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500 transition-colors p-2">
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO PRINCIPAL -->
    <div id="app-content" class="hidden">
        <div class="max-w-5xl mx-auto px-4 py-6">

            <!-- Seletor de Perfil (Para Demo/Testes) -->
            <div class="card p-4 mb-6 border-l-4 border-brand-navy flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase mb-1 block">Simular Perfil:</label>
                    <select id="global-user-select" class="input-field cursor-pointer font-medium text-brand-textMain">
                        <optgroup label="Gestão">
                            <option value="Bruno Diogo">Bruno Diogo</option>
                            <option value="Deyse Pereira">Deyse Pereira</option>
                        </optgroup>
                        <optgroup label="Colaboradores">
                            <option value="Vinicius Sena" selected>Vinicius Sena</option>
                            <option value="Keven Menezes">Keven Menezes</option>
                            <option value="Marllon Costa">Marllon Costa</option>
                            <option value="Gisely Rocha">Gisely Rocha</option>
                            <option value="Vera Nascimento">Vera Nascimento</option>
                        </optgroup>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                    <span id="role-badge" class="block w-full text-center md:inline-block px-4 py-2 rounded bg-blue-50 text-brand-navy text-xs font-bold border border-blue-100">
                        <i class="fa-solid fa-user-shield mr-1"></i> <span id="role-text">Colaborador</span>
                    </span>
                </div>
            </div>

            <!-- Navegação (Abas Desktop / Bottom Mobile) -->
            <nav class="nav-container">
                <div class="nav-btn active" onclick="switchTab('dashboard')" id="nav-dashboard">
                    <i class="fa-solid fa-chart-pie nav-icon"></i>
                    <span class="nav-text">Painel</span>
                </div>
                <div class="nav-btn" onclick="switchTab('registro')" id="nav-registro">
                    <i class="fa-solid fa-clock nav-icon"></i>
                    <span class="nav-text">Ponto</span>
                </div>
                <div class="nav-btn" onclick="switchTab('solicitacoes')" id="nav-solicitacoes">
                    <i class="fa-solid fa-file-signature nav-icon"></i>
                    <span class="nav-text">Abono</span>
                </div>
                <div class="nav-btn" onclick="switchTab('gestao')" id="nav-gestao">
                    <i class="fa-solid fa-users-gear nav-icon"></i>
                    <span class="nav-text">Gestão</span>
                </div>
            </nav>

            <main>
                <!-- VIEW: DASHBOARD -->
                <section id="view-dashboard" class="animate-fade">
                    <!-- Cards de Saldo -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="card p-6 bg-gradient-to-br from-brand-navy to-blue-900 text-white border-none shadow-lg relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-bold text-blue-200 uppercase tracking-widest mb-1">Saldo de Horas Extras</p>
                                <h2 id="dash-saldo" class="text-4xl font-bold my-2">--:--</h2>
                                <div id="dash-status" class="inline-block px-2 py-1 rounded bg-white/20 text-[10px] font-bold uppercase backdrop-blur-sm">
                                    Calculando...
                                </div>
                            </div>
                            <i class="fa-solid fa-stopwatch absolute -bottom-4 -right-4 text-8xl text-white opacity-10"></i>
                        </div>

                        <div class="card p-6 flex flex-col justify-center items-start border-l-4 border-l-brand-orange">
                            <h3 class="font-bold text-brand-navy text-lg mb-2">Regras de Expediente</h3>
                            <ul class="text-sm text-gray-600 space-y-2">
                                <li class="flex items-center gap-2"><i class="fa-solid fa-business-time text-brand-orange"></i> <span>Seg-Sex: Apenas fora de 07:00-17:00</span></li>
                                <li class="flex items-center gap-2"><i class="fa-solid fa-calendar-week text-brand-orange"></i> <span>Dom: Bônus de 24min/hora</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-lg">
                            <h3 class="font-bold text-brand-navy text-sm uppercase">Extrato Recente</h3>
                            <span class="text-xs text-gray-400">Últimos 30 dias</span>
                        </div>
                        <div id="timeline-body">
                            <!-- JS -->
                        </div>
                    </div>
                </section>

                <!-- VIEW: REGISTRO -->
                <section id="view-registro" class="hidden animate-fade">
                    <div class="card max-w-2xl mx-auto">
                        <div class="p-6 border-b border-gray-100 text-center">
                            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3 text-brand-navy">
                                <i class="fa-solid fa-pen-to-square text-xl"></i>
                            </div>
                            <h2 class="font-bold text-lg text-brand-textMain">Novo Registro</h2>
                            <p class="text-xs text-gray-500">Lance suas horas trabalhadas fora do expediente.</p>
                        </div>
                        
                        <form onsubmit="handleRegistro(event)" class="p-6 space-y-6">
                            <input type="text" id="reg-nome" class="hidden">

                            <!-- GRID RESPONSIVO (2 Colunas no Mobile) -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Data</label>
                                    <input type="date" id="reg-data" required class="input-field text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Atividade</label>
                                    <select id="reg-area" class="input-field bg-white text-xs truncate pr-6">
                                        <option value="TI">Cobertura Audiovisual</option>
                                        <option value="Administrativo">Apoio Cerimonial</option>
                                        <option value="Projetos">Postagens Redes</option>
                                        <option value="Engenharia">Criação Material</option>
                                    </select>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded border border-gray-200">
                                <p class="text-center text-[10px] font-bold text-brand-navy uppercase mb-3">Horário Realizado (HH:MM)</p>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <label class="block text-[10px] text-gray-400 font-bold mb-1 text-center">Início</label>
                                        <!-- INPUT MANUAL DE HORA -->
                                        <input type="tel" id="reg-entrada" required class="input-field input-time" placeholder="00:00" maxlength="5" oninput="maskTime(this)">
                                    </div>
                                    <i class="fa-solid fa-arrow-right text-gray-300 mt-4"></i>
                                    <div class="flex-1">
                                        <label class="block text-[10px] text-gray-400 font-bold mb-1 text-center">Fim</label>
                                        <!-- INPUT MANUAL DE HORA -->
                                        <input type="tel" id="reg-saida" required class="input-field input-time" placeholder="00:00" maxlength="5" oninput="maskTime(this)">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Observações</label>
                                <textarea id="reg-obs" rows="2" class="input-field resize-none" placeholder="Motivo do trabalho extra..."></textarea>
                            </div>

                            <button type="submit" class="btn-primary shadow-md">
                                <i class="fa-solid fa-check"></i> Salvar Registro
                            </button>
                        </form>
                    </div>
                </section>

                <!-- VIEW: SOLICITACOES -->
                <section id="view-solicitacoes" class="hidden animate-fade">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6 h-fit">
                            <h3 class="font-bold text-brand-navy text-lg mb-4 border-b border-gray-100 pb-2">Nova Solicitação</h3>
                            <form onsubmit="handleSolicitacao(event)" class="space-y-4">
                                <input type="text" id="abono-nome" class="hidden">
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                                        <input type="date" id="abono-data" required class="input-field">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Horas</label>
                                        <input type="tel" id="abono-horas" required class="input-field input-time" placeholder="00:00" maxlength="5" oninput="maskTime(this)">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Justificativa</label>
                                    <textarea id="abono-motivo" rows="3" required class="input-field" placeholder="Ex: Consulta médica..."></textarea>
                                </div>

                                <button type="submit" class="btn-secondary shadow-md">
                                    <i class="fa-regular fa-paper-plane"></i> Enviar Pedido
                                </button>
                            </form>
                        </div>

                        <div class="card h-fit">
                            <div class="p-4 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700 text-sm">Meus Pedidos</h3>
                            </div>
                            <div id="user-solicitacoes-list" class="p-2 space-y-2">
                                <!-- JS -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VIEW: GESTAO -->
                <section id="view-gestao" class="hidden animate-fade">
                    <!-- Banner de Acesso -->
                    <div id="gestao-alert" class="mb-6 p-4 rounded border text-sm text-center font-medium">
                        Verificando...
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Ranking -->
                        <div class="card overflow-hidden h-fit">
                            <div class="p-4 bg-brand-navy text-white flex justify-between items-center">
                                <h3 class="font-bold text-sm uppercase">Ranking de Saldo</h3>
                                <button onclick="renderRanking()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded">Atualizar</button>
                            </div>
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-bold border-b">
                                    <tr>
                                        <th class="py-3 px-4 text-left">#</th>
                                        <th class="py-3 px-4 text-left">Nome</th>
                                        <th class="py-3 px-4 text-right">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="ranking-body"></tbody>
                            </table>
                        </div>

                        <!-- Aprovações -->
                        <div class="card h-fit">
                            <div class="p-4 border-b border-gray-100 bg-orange-50 rounded-t-lg flex justify-between items-center">
                                <h3 class="font-bold text-brand-orange text-sm uppercase">
                                    <i class="fa-solid fa-clipboard-check mr-1"></i> Pendências
                                </h3>
                            </div>
                            <div id="lista-aprovacoes" class="p-4 space-y-3">
                                <!-- JS -->
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Scripts (Funcionalidade Mantida e Chaves Inseridas) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOJ0ca2hpVmFX61aq0asYliQld7t1enNE",
          authDomain: "banco-de-horas-846f7.firebaseapp.com",
          projectId: "banco-de-horas-846f7",
          storageBucket: "banco-de-horas-846f7.firebasestorage.app",
          messagingSenderId: "445693207380",
          appId: "1:445693207380:web:14d35b3a53f21a8cc65ec1"
        };

        // Lógica de Seleção de Configuração
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'banco-horas-evereste-v1';

        const state = {
            currentUser: null,
            selectedProfile: 'Vinicius Sena',
            jornadas: [],
            solicitacoes: [],
            isManager: false
        };

        // --- UX Helpers ---
        window.showToast = (msg, type = 'info') => {
            const el = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'error' ? 'border-red-500 text-red-600' : 'border-green-500 text-green-700';
            const icon = type === 'error' ? 'fa-circle-xmark' : 'fa-circle-check';
            
            toast.className = `toast ${color}`;
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="font-medium text-sm">${msg}</span>`;
            el.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        };

        // Máscara de Hora (HH:MM)
        window.maskTime = (input) => {
            let v = input.value.replace(/\D/g, ''); // Remove não números
            if (v.length > 4) v = v.slice(0, 4); // Limita a 4 dígitos
            if (v.length > 2) {
                input.value = `${v.slice(0, 2)}:${v.slice(2)}`;
            } else {
                input.value = v;
            }
        };

        function minsToTime(m) {
            const abs = Math.abs(m);
            return `${m < 0 ? '-' : ''}${String(Math.floor(abs/60)).padStart(2,'0')}:${String(abs%60).padStart(2,'0')}`;
        }
        
        function timeToMins(t) { 
            if(!t || !t.includes(':')) return 0;
            const [h,m] = t.split(':').map(Number); 
            return h*60+m; 
        }

        // --- Core ---
        async function init() {
            // Timeout de Segurança para remover carregamento se Auth travar
            setTimeout(() => {
                const loader = document.getElementById('loading-overlay');
                if (loader && loader.style.display !== 'none' && !state.currentUser) {
                    loader.style.display = 'none';
                    document.getElementById('login-screen').classList.remove('hidden');
                    console.log("Forced loader removal due to timeout");
                }
            }, 3000); // 3 segundos

            try {
                // Tenta autenticação
                await signInAnonymously(auth);

                onAuthStateChanged(auth, user => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    if(user) {
                        state.currentUser = user;
                        // Mostrar tela de login primeiro
                        document.getElementById('login-screen').classList.remove('hidden');
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                    }
                });
            } catch(e) { 
                console.error(e);
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').classList.remove('hidden'); // Fallback
                showToast("Erro de conexão. Modo offline.", "error");
            }

            document.getElementById('global-user-select').addEventListener('change', (e) => {
                state.selectedProfile = e.target.value;
                updateUI();
                renderDashboard();
                renderSolicitacoes();
            });
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reg-data').value = today;
            document.getElementById('abono-data').value = today;
        }

        // --- Login ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            const pass = document.getElementById('login-password').value;
            
            if(pass.length < 3) return showToast("Senha inválida", "error");

            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = "Autenticando...";

            // Simulação de Identificação
            const select = document.getElementById('global-user-select');
            if(email.includes('bruno')) { select.value = 'Bruno Diogo'; }
            else if(email.includes('vinicius')) { select.value = 'Vinicius Sena'; }
            else { select.value = 'Vinicius Sena'; } 

            state.selectedProfile = select.value;
            
            // Iniciar ouvintes apenas agora
            setupListeners();
            updateUI();

            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                switchTab('dashboard');
                showToast(`Bem-vindo, ${state.selectedProfile}`);
            }, 800);
        };

        window.handleLogout = () => {
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        };

        // --- Data Logic ---
        function setupListeners() {
            const qJornadas = collection(db, 'artifacts', appId, 'public', 'data', 'jornadas');
            const qSolic = collection(db, 'artifacts', appId, 'public', 'data', 'solicitacoes_abono');

            onSnapshot(qJornadas, s => {
                state.jornadas = s.docs.map(d => ({id:d.id, ...d.data()}));
                renderDashboard();
                renderRanking();
            });
            onSnapshot(qSolic, s => {
                state.solicitacoes = s.docs.map(d => ({id:d.id, ...d.data()}));
                renderSolicitacoes();
                renderApprovals();
            });
        }

        function updateUI() {
            const user = state.selectedProfile;
            state.isManager = ['Bruno Diogo', 'Deyse Pereira'].includes(user);

            document.getElementById('header-user-name').textContent = user;
            document.getElementById('reg-nome').value = user;
            document.getElementById('abono-nome').value = user;
            
            const roleText = state.isManager ? 'Gestor' : 'Colaborador';
            document.getElementById('role-text').textContent = roleText;
            
            const badge = document.getElementById('role-badge');
            if(state.isManager) {
                badge.className = "block w-full text-center md:inline-block px-4 py-2 rounded bg-green-50 text-green-700 text-xs font-bold border border-green-100";
                badge.innerHTML = `<i class="fa-solid fa-user-shield mr-1"></i> Gestor`;
            } else {
                badge.className = "block w-full text-center md:inline-block px-4 py-2 rounded bg-blue-50 text-brand-navy text-xs font-bold border border-blue-100";
                badge.innerHTML = `<i class="fa-solid fa-user mr-1"></i> Colaborador`;
            }

            const alert = document.getElementById('gestao-alert');
            if(state.isManager) {
                alert.className = "mb-6 p-4 rounded border border-green-200 bg-green-50 text-green-800 text-sm text-center font-bold";
                alert.innerHTML = "Acesso de Gestor Confirmado";
            } else {
                alert.className = "mb-6 p-4 rounded border border-red-200 bg-red-50 text-red-800 text-sm text-center";
                alert.innerHTML = "Acesso Restrito (Apenas Visualização)";
            }
        }

        // --- Render Views ---
        function renderDashboard() {
            const list = state.jornadas.filter(j => j.nome === state.selectedProfile).sort((a,b) => new Date(b.data) - new Date(a.data));
            const total = list.reduce((acc, cur) => acc + cur.saldoMinutos, 0);

            // Saldo
            const elSaldo = document.getElementById('dash-saldo');
            elSaldo.textContent = minsToTime(total);
            elSaldo.className = total >= 0 ? "text-4xl font-bold my-2 text-white" : "text-4xl font-bold my-2 text-red-200";
            
            const elStatus = document.getElementById('dash-status');
            elStatus.textContent = total >= 0 ? "Saldo Positivo" : "Saldo Devedor";
            elStatus.className = total >= 0 ? "inline-block px-2 py-1 rounded bg-green-500 text-white text-[10px] font-bold uppercase shadow-sm" : "inline-block px-2 py-1 rounded bg-red-500 text-white text-[10px] font-bold uppercase shadow-sm";

            // Timeline
            const tl = document.getElementById('timeline-body');
            tl.innerHTML = '';
            
            if(list.length === 0) {
                tl.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">Nenhum registro encontrado.</div>';
                return;
            }

            list.forEach(j => {
                const isWork = j.tipo === 'trabalho';
                const colorClass = j.saldoMinutos >= 0 ? 'text-brand-navy' : 'text-red-500';
                tl.innerHTML += `
                    <div class="timeline-row">
                        <div class="mr-4 text-center min-w-[50px]">
                            <span class="block text-xs font-bold text-gray-400 uppercase">${new Date(j.data).toLocaleDateString('pt-PT', {day:'2-digit', month:'short'})}</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-gray-700">${isWork ? 'Jornada Extra' : 'Abono/Ajuste'}</h4>
                            <p class="text-xs text-gray-500 italic truncate max-w-[150px] md:max-w-xs">${j.obs || ''}</p>
                        </div>
                        <div class="text-right">
                            <span class="font-mono font-bold text-sm ${colorClass}">${minsToTime(j.saldoMinutos)}</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderSolicitacoes() {
            const list = state.solicitacoes.filter(s => s.nome === state.selectedProfile);
            const el = document.getElementById('user-solicitacoes-list');
            el.innerHTML = '';
            
            if(list.length === 0) { el.innerHTML = '<div class="text-center py-4 text-gray-400 text-xs">Sem pedidos.</div>'; return; }

            list.forEach(s => {
                let badge = s.status === 'approved' ? 'bg-green-100 text-green-800' : s.status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                el.innerHTML += `
                    <div class="p-3 bg-white border border-gray-100 rounded shadow-sm flex justify-between items-center">
                        <div>
                            <span class="text-xs font-bold text-gray-700 block">${new Date(s.data).toLocaleDateString('pt-PT')}</span>
                            <span class="text-[10px] text-gray-500">${s.horasSolicitadas}h - "${s.motivo}"</span>
                        </div>
                        <span class="${badge} px-2 py-1 rounded text-[10px] font-bold uppercase">${s.status}</span>
                    </div>
                `;
            });
        }

        function renderApprovals() {
            const list = state.solicitacoes.filter(s => s.status === 'pending');
            const el = document.getElementById('lista-aprovacoes');
            el.innerHTML = '';
            
            if(list.length === 0) { el.innerHTML = '<div class="text-center py-6 text-gray-400 text-sm">Tudo limpo! Nenhuma pendência.</div>'; return; }

            list.forEach(r => {
                el.innerHTML += `
                    <div class="bg-white border border-gray-200 p-4 rounded shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-sm text-brand-navy">${r.nome}</h4>
                            <span class="bg-gray-100 text-gray-600 font-mono text-xs px-2 py-1 rounded font-bold">${r.horasSolicitadas}h</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 italic bg-gray-50 p-2 rounded">"${r.motivo}"</p>
                        <div class="flex gap-2">
                            <button onclick="processApproval('${r.id}', true)" class="flex-1 bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700 ${!state.isManager?'opacity-50':''}" ${!state.isManager?'disabled':''}>APROVAR</button>
                            <button onclick="processApproval('${r.id}', false)" class="flex-1 border border-red-200 text-red-600 py-2 rounded text-xs font-bold hover:bg-red-50 ${!state.isManager?'opacity-50':''}" ${!state.isManager?'disabled':''}>REJEITAR</button>
                        </div>
                    </div>
                `;
            });
        }

        window.renderRanking = () => {
            const totals = {};
            state.jornadas.forEach(j => totals[j.nome] = (totals[j.nome]||0) + j.saldoMinutos);
            const sorted = Object.keys(totals).map(k=>({n:k, s:totals[k]})).sort((a,b)=>b.s-a.s);
            const el = document.getElementById('ranking-body');
            el.innerHTML = '';
            sorted.forEach((r,i) => {
                el.innerHTML += `
                    <tr class="border-b last:border-0 hover:bg-gray-50">
                        <td class="py-3 px-4 text-xs font-bold text-gray-400">#${i+1}</td>
                        <td class="py-3 px-4 font-medium text-gray-700">${r.n}</td>
                        <td class="py-3 px-4 text-right font-mono font-bold ${r.s>=0?'text-brand-navy':'text-red-500'}">${minsToTime(r.s)}</td>
                    </tr>
                `;
            });
        }

        // --- Actions ---
        window.handleRegistro = async (e) => {
            e.preventDefault();
            const form = {
                nome: document.getElementById('reg-nome').value,
                data: document.getElementById('reg-data').value,
                in: document.getElementById('reg-entrada').value,
                out: document.getElementById('reg-saida').value,
                area: document.getElementById('reg-area').value,
                obs: document.getElementById('reg-obs').value
            };

            const minIn = timeToMins(form.in);
            const minOut = timeToMins(form.out);
            if(minOut <= minIn) return showToast('Saída deve ser após entrada', 'error');

            const day = new Date(form.data).getDay();
            const isWeekend = (day === 0 || day === 6);
            let bal = 0;
            let obs = form.obs;

            if(isWeekend) {
                bal = minOut - minIn;
                if(day === 0) {
                    const bonus = Math.round((bal/60)*24);
                    bal += bonus;
                    obs += ` (+${bonus}min Dom)`;
                }
            } else {
                const start = 420; // 07:00
                const end = 1020;  // 17:00
                const before = Math.max(0, start - minIn);
                const after = Math.max(0, minOut - end);
                bal = before + after;
                
                if(bal === 0) return showToast("Horário dentro do expediente normal (07-17).", "error");
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jornadas'), {
                    nome: form.nome, data: form.data, entrada: form.in, saida: form.out, area: form.area,
                    obs, tipo: 'trabalho', saldoMinutos: bal, timestamp: serverTimestamp()
                });
                showToast("Registrado com sucesso!");
                e.target.reset();
                switchTab('dashboard');
            } catch(e) { showToast(e.message, 'error'); }
        };

        window.handleSolicitacao = async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'solicitacoes_abono'), {
                    nome: document.getElementById('abono-nome').value,
                    data: document.getElementById('abono-data').value,
                    horasSolicitadas: document.getElementById('abono-horas').value,
                    motivo: document.getElementById('abono-motivo').value,
                    status: 'pending', timestamp: serverTimestamp()
                });
                showToast("Solicitação enviada.");
                e.target.reset();
            } catch(e) { showToast(e.message, 'error'); }
        };

        window.processApproval = async (id, approved) => {
            if(!state.isManager) return;
            const req = state.solicitacoes.find(s => s.id === id);
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'solicitacoes_abono', id), {status: approved?'approved':'rejected'});
                if(approved) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jornadas'), {
                        nome: req.nome, data: req.data, tipo: 'abono', saldoMinutos: -timeToMins(req.horasSolicitadas),
                        obs: `Abono: ${req.motivo}`, timestamp: serverTimestamp()
                    });
                }
                showToast(approved ? 'Aprovado' : 'Rejeitado');
            } catch(e) { console.error(e); }
        };

        // --- Navigation ---
        window.switchTab = (id) => {
            ['dashboard','registro','solicitacoes','gestao'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('active');
            
            if(id === 'gestao') { renderApprovals(); renderRanking(); }
        };

        init();
    </script>
</body>
</html>